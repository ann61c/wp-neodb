class WP_NEODB{constructor(){this.ver="1.0.5",this.type="movie",this.status="done",this.finished=!1,this.paged=1,this.genre_list=[],this.genre=[],this.subjects=[],this._create()}on(e,t,s){document.querySelectorAll(t).forEach((t=>{t.addEventListener(e,s)}))}_addSearchParams(e,t={}){return e=new URL(e),new URL(`${e.origin}${e.pathname}?${new URLSearchParams([...Array.from(e.searchParams.entries()),...Object.entries(t)])}`).href}_fetchGenres(){document.querySelector(".db--genres").innerHTML="";const e=wpn_base.token?"https://node.wpista.com/v1/outer/genres?token="+wpn_base.token:wpn_base.api+"v1/movie/genres";return fetch(this._addSearchParams(e,{type:this.type})).then((e=>e.json())).then((e=>{const t=wpn_base.token?e.data:e;t.length&&(this.genre_list=t,this._renderGenre())})),!0}_statusChange(){this.on("click",".db--typeItem",(e=>{const t=e.currentTarget;t.classList.contains("is-active")||(document.querySelector(".db--list").innerHTML="",document.querySelector(".lds-ripple").classList.remove("u-hide"),document.querySelector(".db--typeItem.is-active").classList.remove("is-active"),t.classList.add("is-active"),this.status=t.dataset.status,this.paged=1,this.finished=!1,this.subjects=[],this._fetchData())}))}_handleGenreClick(){this.on("click",".db--genreItem",(e=>{const t=e.currentTarget;if(t.classList.contains("is-active")){const e=this.genre.indexOf(t.innerText);return t.classList.remove("is-active"),this.genre.splice(e,1),this.paged=1,this.finished=!1,this.subjects=[],void this._fetchData()}document.querySelector(".db--list").innerHTML="",document.querySelector(".lds-ripple").classList.remove("u-hide"),t.classList.add("is-active"),this.genre.push(t.innerText),this.paged=1,this.finished=!1,this.subjects=[],this._fetchData()}))}_renderGenre(){document.querySelector(".db--genres").innerHTML=this.genre_list.map((e=>`<span class="db--genreItem${this.genre_list.includes(e.name)?" is-active":""}">${e.name}</span>`)).join(""),this._handleGenreClick()}_fetchData(){const e=wpn_base.token?"https://node.wpista.com/v1/outer/faves":wpn_base.api+"v1/movies";fetch(this._addSearchParams(e,{token:wpn_base.token,type:this.type,paged:this.paged,genre:JSON.stringify(this.genre),status:this.status})).then((e=>e.json())).then((e=>{const t=wpn_base.token?e.data:e;t.length?(document.querySelector(".db--list").classList.contains("db--list__card")?(this.subjects=[...this.subjects,...t],this._randerDateTemplate()):(this.subjects=[...this.subjects,...t],this._randerListTemplate()),document.querySelector(".lds-ripple").classList.add("u-hide")):(document.querySelector(".db--list").classList.contains("db--list__card")?this._randerDateTemplate():this._randerListTemplate(),this.finished=!0,document.querySelector(".lds-ripple").classList.add("u-hide"))}))}_randerDateTemplate(){if(!this.subjects.length)return document.querySelector(".db--list").innerHTML='<div class="db--empty"></div>';const e=this.subjects.reduce(((e,t)=>{const s=new Date(t.create_time),i=`${s.getFullYear()}-${(s.getMonth()+1).toString().padStart(2,"0")}`;return Object.prototype.hasOwnProperty.call(e,i)?e[i].push(t):e[i]=[t],e}),{});let t="";for(let s in e){const i=s.split("-");t+=`<div class="db--listBydate"><div class="db--titleDate JiEun"><div class="db--titleDate__day">${i[1]}</div><div class="db--titleDate__month">${i[0]}</div></div><div class="db--dateList__card">`,t+=e[s].map((e=>`<div class="db--item">${e.is_top250?'<span class="top250">Top 250</span>':""}<img src="${e.poster}" referrerpolicy="unsafe-url" class="db--image"><div class="db--score JiEun">${e.douban_score>0?'<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" ><path d="M12 20.1l5.82 3.682c1.066.675 2.37-.322 2.09-1.584l-1.543-6.926 5.146-4.667c.94-.85.435-2.465-.799-2.567l-6.773-.602L13.29.89a1.38 1.38 0 0 0-2.581 0l-2.65 6.53-6.774.602C.052 8.126-.453 9.74.486 10.59l5.147 4.666-1.542 6.926c-.28 1.262 1.023 2.26 2.09 1.585L12 20.099z"></path></svg>'+e.douban_score:""}${e.year>0?" · "+e.year:""}</div><div class="db--title"><a href="${this._fixLink(e.link)}" target="_blank">${e.name}</a></div>\n    \n    </div>`)).join(""),t+="</div></div>"}document.querySelector(".db--list").innerHTML=t}_randerListTemplate(){if(!this.subjects.length)return document.querySelector(".db--list").innerHTML='<div class="db--empty"></div>';document.querySelector(".db--list").innerHTML=this.subjects.map((e=>`<div class="db--item">${e.is_top250?'<span class="top250">Top 250</span>':""}<img src="${e.poster}" referrerpolicy="unsafe-url" class="db--image"><div class="ipc-signpost JiEun">${e.create_time}</div><div class="db--score JiEun">${e.douban_score>0?'<svg width="12" height="12" viewBox="0 0 24 24" fill="currentColor" ><path d="M12 20.1l5.82 3.682c1.066.675 2.37-.322 2.09-1.584l-1.543-6.926 5.146-4.667c.94-.85.435-2.465-.799-2.567l-6.773-.602L13.29.89a1.38 1.38 0 0 0-2.581 0l-2.65 6.53-6.774.602C.052 8.126-.453 9.74.486 10.59l5.147 4.666-1.542 6.926c-.28 1.262 1.023 2.26 2.09 1.585L12 20.099z"></path></svg>'+e.douban_score:""}${e.year>0?" · "+e.year:""}</div><div class="db--title"><a href="${this._fixLink(e.link)}" target="_blank">${e.name}</a></div>\n                </div>\n                </div>`)).join("")}_handleScroll(){window.addEventListener("scroll",(()=>{var e=window.scrollY||window.pageYOffset;document.querySelector(".block-more").offsetTop+-window.innerHeight<e&&document.querySelector(".lds-ripple").classList.contains("u-hide")&&!this.finished&&(document.querySelector(".lds-ripple").classList.remove("u-hide"),this.paged++,this._fetchData())}))}_handleNavClick(){this.on("click",".db--navItem",(e=>{if(e.target.classList.contains("current"))return;this.genre=[],this.type=e.target.dataset.type,"book"!=this.type?(this._fetchGenres(),document.querySelector(".db--genres").classList.remove("u-hide")):document.querySelector(".db--genres").classList.add("u-hide"),document.querySelector(".db--list").innerHTML="",document.querySelector(".lds-ripple").classList.remove("u-hide"),document.querySelector(".db--navItem.current").classList.remove("current");e.target.classList.add("current"),this.paged=1,this.finished=!1,this.subjects=[],this._fetchData()}))}_create(){document.querySelector(".db--container")&&(document.querySelector(".db--navItem.current")&&(this.type=document.querySelector(".db--navItem.current").dataset.type),document.querySelector(".db--list").dataset.type&&(this.type=document.querySelector(".db--list").dataset.type),"movie"==this.type&&document.querySelector(".db--genres").classList.remove("u-hide"),this._fetchGenres(),this._fetchData(),this._handleScroll(),this._handleNavClick(),this._statusChange()),document.querySelector(".db--collection")&&document.querySelectorAll(".db--collection").forEach((e=>{this._fetchCollection(e)}))}_fixLink(e){if(!e)return"";if(e.startsWith("/")&&wpn_base.neodb_url){return wpn_base.neodb_url.replace(/\/+$/,"")+"/"+e.replace(/^\/+/,"")}return e}_fetchCollection(e){const t=e.dataset.style?e.dataset.style:"card",s=wpn_base.token?"https://node.wpista.com/v1/outer/faves?token="+wpn_base.token:wpn_base.api+"v1/movies";fetch(this._addSearchParams(s,{type:this.type,paged:1,start_time:e.dataset.start,end_time:e.dataset.end,status:e.dataset.status})).then((e=>e.json())).then((s=>{const i=wpn_base.token?s.data:s;if(i.length)if("card"==t)e.innerHTML+=i.map((e=>`<div class="doulist-item">\n                            <div class="doulist-subject">\n                            <div class="db--viewTime JiEun">Marked ${e.create_time}</div>\n                            <div class="doulist-post"><img referrerpolicy="unsafe-url" src="${e.poster}"></div><div class="doulist-content"><div class="doulist-title"><a href="${this._fixLink(e.link)}" class="cute" target="_blank" rel="external nofollow">${e.name}</a></div><div class="rating"><span class="allstardark"><span class="allstarlight" style="width:75%"></span></span><span class="rating_nums">${e.douban_score}</span></div><div class="abstract">${e.remark||e.card_subtitle}</div></div></div></div>`)).join("");else{const t=i.reduce(((e,t)=>(Object.prototype.hasOwnProperty.call(e,t.create_time)?e[t.create_time].push(t):e[t.create_time]=[t],e)),{});let s="";for(let e in t)s+=`<div class="db--date">${e}</div><div class="db--dateList">`,s+=t[e].map((e=>`<div class="db--card__list"">\n                                    <img referrerpolicy="unsafe-url" src="${e.poster}">\n                                    <div>\n                                    <div class="title"><a href="${this._fixLink(e.link)}" class="cute" target="_blank" rel="external nofollow">${e.name}</a></div>\n                                    <div class="rating"><span class="allstardark"><span class="allstarlight" style="width:75%"></span></span><span class="rating_nums">${e.douban_score}</span></div>\n                                    ${e.remark||e.card_subtitle}\n                                    </div>\n                                    </div>`)).join(""),s+="</div>";e.innerHTML=s}}))}}new WP_NEODB;